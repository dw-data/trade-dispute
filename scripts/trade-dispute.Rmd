---
title: "The real winners of the US-China trade dispute"
number_sections: yes
output:
  md_document:
    variant: gfm
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "/Users/schachtk/Documents/DW/xxx_trade-dispute/")
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
options(scipen = 999)
```


# The real winners of the US-China trade dispute

China and the US have been locked in a trade dispute for more than two years. With prices for Chinese products rising, where do US consumers and manufacturers import from instead? This DW analysis shows how global trade flows have shifted, and how it’s changing the lives of those affected

*Idea:* Analyze import redirection. If US consumers and manufacturers have to pay more for Chinese products due to high tariffs, they might choose to import from alternative countries instead. We analyze which countries have seen a higher-than-expected rise in US import market shares, and which specific products have been substituted.

This analysis broadly follows the methodology of the study on US-China trade diversion from [Nomura, 2019](https://www.nomuraconnects.com/focused-thinking-posts/us-china-trade-diversion-who-benefits/), but looking at the timeframe from Q4 2017 (before the start of the trade dispute) to Q4 2019 (after two years of trade dispute, but before the Covid-19 pandemic). The analysis then looks at what has changed since the pandemic started. 

*In this repository, you will find the methodology, data and code behind the story that came out of this analysis.*

**Read the full article on DW.com:** [English](https://www.dw.com/a-xxx) | [German](https://www.dw.com/a-xxx)

**Story by:** [Kira Schacht](https://twitter.com/daten_drang), Christine Laskowski


# Data sources

For this project, we'll be using the following datasets:

- Quarterly imports to the US and China by origin country and product (4-digit HS code level), Q3 2015 - Q2 2020, Source: [ITC Trade Map](https://www.trademap.org/)
- Product codes tariffed in the US-China trade dispute, Source: [USTR](https://ustr.gov/issue-areas/enforcement/section-301-investigations/search)
- Country names and corresponding ISO-3 country codes, Source: [World Trade Organization](https://docs.wto.org/gtd/Default.aspx?pagename=WTOIsocodes&langue=e)
- Country codes with corresponding regions and continents, source: [UN Statistics Division](https://unstats.un.org/unsd/methodology/m49/) 
- GDP by country 2018, Source: [World Bank (NY.GDP.MKTP.CD)](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD), data for Taiwan from [WTO Trade Profile](https://www.wto.org/english/res_e/statis_e/daily_update_e/trade_profiles/TW_e.pdf)


# Analysis


```{r}
## install and load needs, if not yet present
# install.packages("needs")
library(needs)

# packages used in this markdown document
needs(tidyverse, rvest, jsonlite, ggbeeswarm, dwplot)

dw_gradient = c("blau6" = "#002d5a", "blau5" = "#004887", "blau4" = "#0064b4", "blau3" = "#007acd", "blau2" = "#008fe6", "blau1" = "#00a5ff", "gelb" = "#f0c80f", "orangegelb" = "#f0aa00", "Hellorange" = "#ee8c0a", "Orange" = "#eb6e14", "Orangerot" = "#d44820", "rot" = "#be232d")
dw_info = c("hellblau" = "#00a5ff", "dunkelblau" = "#002d5a", "orangerot" = "#EE8C0A",
            "grün" = "#96be00", "rot" = "#be232d", "gelb" = "#f0c80f")
dw_grey = c("grey14" = "#323c45", "grey13" = "#3b444d", "grey12" = "#4b545c", "grey11" = "#5c666e",
            "grey10" = "#6d7780", "grey9" = "#7f8891", "grey8" = "#9099a3", "grey7" = "#a1abb4", "grey6" = "#b2bcc5",
            "grey5" = "#bfc7ce", "grey4" = "#cbd2d8", "grey3" = "#d8dde2", "grey2" = "#e4e8eb", "grey1" = "#f1f3f5") %>% rev()
```

## 0. Read data

countries included in this analysis:

- 10 biggest economies per continent by gdp
- 50 biggest economies globally by gdp
- excluding Cuba, which didn't import anything to the US  in 2017

```{r}
#gdp data

#source taiwan GDP 2018: https://www.wto.org/english/res_e/statis_e/daily_update_e/trade_profiles/TW_e.pdf
cc = read.csv2("data/processed/input/WTO_country_codes_ISO3.csv", stringsAsFactors = F) %>% 
  rename(country = X...country) %>% 
  mutate(country = gsub("Saudi Arabia, Kingdom of","Saudi Arabia", country)) %>% 
  bind_rows(data.frame(country = "Taipei, Chinese", iso.code = "TWN")) %>% 
  left_join(read.csv2("data/processed/input/country-and-continent-codes-list.csv",
                      stringsAsFactors = F, na.strings = c("","NA"))[c(6,1:3,8)],
            by = c("iso.code" = "ISO.alpha3.code"))

gdp = read.csv2("data/processed/input/Worldbank_GDP_NY.GDP.MKTP.CD.csv",
                stringsAsFactors = F, na.strings = c("NA","","..")) %>%
  select(iso.code = Country.Code, gdp18 = X2018..YR2018.) %>% 
  bind_rows(data.frame(iso.code = "TWN", gdp18=589391*10^6)) %>% arrange(-gdp18) %>% 
  left_join(cc)
rm(cc)

#top 10 by continent
top10c = gdp %>% group_by(continent) %>%
  filter(iso.code != "USA") %>% slice_max(gdp18, n = 10)

#top 50 overall
top50 = gdp %>% arrange(-gdp18) %>% filter(iso.code != "USA") %>%
  head(50) %>% arrange(country)

full_join(top10c, top50) %>% select(1,3,4,2) %>%
  filter(!is.na(country)) %>% mutate(gdp18 = gdp18/10^9) %>% 
  arrange(continent, country) #%>% knitr::kable(digits = 2)
rm(top10c, top50)
```



```{r include=FALSE}
#check if data is already there. if not, read it from html tables
if(file.exists("scripts/data.RData")){
  load("scripts/data.RData")
} else {


#read data
  
#list product codes, append short names
p = read_html("data/processed/input/trade/Trade_Map_-_List_of_products_imported_by_United_States_of_America.xls") %>%
    html_nodes("table") %>% `[[`(7) %>% html_table(fill = T, trim = T) %>% `[`(1:2) %>%
    setNames(c("p.code","p.label")) %>% mutate(p.code = gsub("'","",p.code)) %>%
  left_join(read.delim("data/processed/input/product_names.tsv", stringsAsFactors = F, colClasses = "character")) %>% 
  mutate(p.code.clean = ifelse(is.na(p.code.clean), p.code, p.code.clean))
  
#list of tariffed products
t = fromJSON("data/processed/input/tariffed_products.json") %>% `[[`(1) %>% select(1:4) %>% 
  filter(action_description != "(List 4B) $300 Billion Tariff Action") %>% #List 4B was cancelled
  mutate(HTS_id = substr(HTS_id,1,4),
         a_vol = factor(action, levels = c("$34B","$16B","$200B","$300B"),
                         labels = c("$34B","$16B","$200B","$112B")),
         a_name = factor(action_description, labels = c("List 1","List 2","List 3","List 4A"))) %>% 
  group_by(HTS_id) %>% summarise(a_vol = a_vol %>% unique %>% paste(collapse = ","),
                                 a_name = a_name %>% unique %>% paste(collapse = ",")) %>% 
  as.data.frame() %>% 
  left_join(p[c(1,3)], by = c("HTS_id" = "p.code"))

quarters = expand.grid(2015:2020,paste0("Q",1:4)) %>% apply(. , 1, "paste", collapse="-") %>% sort %>% `[`(3:22)

#total trade data

d_usa_total = read_html("data/processed/input/trade/Trade_Map_-_List_of_products_imported_by_United_States_of_America.xls") %>%
    html_nodes("table") %>% `[[`(7) %>% html_table(fill = T, trim = T) %>% select(-2) %>% 
    setNames(c("p.code",quarters)) %>% 
  gather(quarter,value,2:21) %>% mutate(p.code = gsub("'","",p.code))

d_china_total = read_html("data/processed/input/trade/Trade_Map_-_List_of_products_imported_by_China.xls") %>%
    html_nodes("table") %>% `[[`(7) %>% html_table(fill = T, trim = T) %>% select(-2) %>% 
    setNames(c("p.code",quarters)) %>% 
  gather(quarter,value,2:21) %>% mutate(p.code = gsub("'","",p.code))

#country data

d_china = "data/processed/input/trade/trade_china/Trade_Map_-_Bilateral_trade_between_China_and_United_States_of_America.xls" %>% 
  read_html() %>% html_nodes("table") %>% `[[`(7) %>% html_table(fill = T, trim = T) %>%
  `[`(-(1:2), 1:(length(quarters) + 2)) %>% select(-2) %>% 
  setNames(c("p.code", quarters)) %>% 
  gather(quarter,value,2:(length(quarters) + 1)) %>%
  mutate(country = "United States of America", value = as.numeric(value), p.code = gsub("'","",p.code))

#file list
l = list.files("data/processed/input/trade/trade_usa", pattern = "Trade_Map_-_Bilateral")

#country names
ct = l %>% gsub(paste0(".+_and_|\\.xls"),"",.) %>% gsub("__",", ",.) %>% gsub("_"," ",.)


tmp = vector("list", length(l))
for(i in 1:length(tmp)){
  #status
  cat(i, "of", length(tmp), "\t", l[i],"\n")
  
  tmp[[i]] = paste0("data/raw/trade_usa/",l[i]) %>%
    read_html() %>% html_nodes("table") %>% `[[`(7) %>% html_table(fill = T, trim = T) %>%
    `[`(-(1:2), 1:(length(quarters) + 2)) %>% select(-2) %>% 
    setNames(c("p.code", quarters)) %>% 
    gather(quarter,value,2:(length(quarters) + 1)) %>%
    mutate(country = ct[i], value = as.numeric(value), p.code = gsub("'","",p.code))
}
#merge dataset
d_usa = tmp %>% bind_rows();rm(tmp)
rm(i,l,ct,quarters)

#save result
save.image("scripts/data.RData")

}
#check data for completeness

#is data on all 20 quarters there for all countries?
d_usa %>% filter(p.code == "TOTAL") %>% group_by(country) %>% summarise(n = n()) %>% `$`(n) %>% all(.==20)
#yup

#are all extant product codes in the product dataset?
d_usa$p.code %>% unique() %>% `%in%`(p$p.code) %>% table
#yup
```


Dataset overview: 

`d_usa`   imports to the USA from the 50 biggest economies (GDP) plus Taiwan, by:
  
- `p.code`:  product codes (HS4)
- `quarter`: quarter (Q3 2015 - Q2 2020)
- `country`: import country
- `value`: value in thousand USD


`d_usa_total`   total imports to the USA by:
  
- `p.code`:  product code (HS4)
- `quarter`: quarter (Q3 2015 - Q2 2020)
- `value`: value in thousand USD

Equivalent for `d_china_total` and `d_china`.

`p`   list of 4-digit product codes and descriptions:
  
- `p.code`:  product code (HS4)
- `p.label`: official product description (HS4)
- `p.code.clean`: consolidated product codes for use with this analysis
- `short.name`: short product labels for use with this analysis

For this analysis, we have merged some product codes and given labels where appropriate. A list of all labels and groupings can be found in the file `product_names.tsv`.

`t`   list of tariffed products by
  
- `HTS_id`:  product code (HS4)
- `a_vol`: volume of the corresponding tariff action(s)
- `a_name`: label of the corresponding tariff action(s) (Lists 1 through 4)

`gdp` GDP 2018 by country, region and continent

## 1. Overview of trade between US and China

### 1.1 How has trade between the US and China changed?

#### Total US import volume over time

```{r}
x = d_usa_total %>% filter(p.code == "TOTAL")
ggplot(x, aes(quarter, value/10^6, group = 0)) +
  geom_line(size = 2, colour = "#00a5ff", lineend = "round") +
  geom_vline(xintercept = c(13,19), colour =  "#002d5a", size = 1) +
  annotate("text", c(13,19)-.2, y = .005, hjust = 1, vjust = 0,
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\nCovid a pandemic")) +
  scale_y_continuous(limits = c(0,max(x$value)/10^6), labels = scales::comma) +
  labs(y="billion USD", title = "Total US import volume over time") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The total US trade volume decreased during the trade dispute, and even more during the pandemic.

#### US imports from China vs China's imports from the US

```{r}
#calculate values and market shares for imports from china to the US and vice versa
tmp = d_usa_total %>% filter(p.code == "TOTAL")
x = d_usa %>% filter(p.code == "TOTAL", country == "China") %>%
  left_join(tmp, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = value.country / value.total)
tmp = d_china_total %>% filter(p.code == "TOTAL")
x = d_china %>% filter(p.code == "TOTAL", country == "United States of America") %>%
  left_join(tmp, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = value.country / value.total) %>%
  bind_rows(x) %>% mutate(country = ifelse(country == "China",
                                           "US imports from China","China's imports from US"))
```


**in USD**
```{r}
ggplot(x, aes(quarter, value.country/10^6, color = country, group = country)) + 
  geom_line(size = 2, lineend = "round") +
  geom_vline(xintercept = c(13,19), colour =  "#002d5a", size = 1) +
  annotate("text", c(13,19)-.2, y = .005, hjust = 1, vjust = 0,
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\nCovid a pandemic")) +
  scale_color_manual(values = c("#002d5a","#00a5ff")) +
  scale_y_continuous(limits = c(0,max(x$value.country)/10^6), labels = scales::comma) +
  labs(y="billion USD", title = "China imports from the US (total volume in USD)") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**in percent (market share)**
```{r}
plot = ggplot(x, aes(quarter, share, group = country, color = country)) + 
  geom_line(size = 8, lineend = "round") +
  geom_vline(xintercept = c(13,19), colour =  "#002d5a", size = 4) +
  annotate("text", c(13,19)-.2, y = .005, hjust = 1, vjust = 0, colour = dw_grey[13],
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\nCovid a pandemic"), size = 18) +
  scale_color_manual(values = c("#002d5a","#00a5ff")) +
  scale_y_continuous(limits = c(0,max(x$share)+.02), expand = expansion(mult = 0),
                     labels = scales::percent_format(accuracy = 1)) +
  labs(y="percent of all imports", title = "US imports from China\npick up again during pandemic",
       caption = "US imports from China and vice versa, percent of all imports") +
  theme_minimal()

ggsave("graphics/video/svg/trade_dispute_1_line.svg", plot, device = "svg", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.3)
ggsave("graphics/video/png/trade_dispute_1_line.png", plot, device = "png", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.3)

plot = plot + theme_dw() +
  scale_x_discrete(labels = ifelse(grepl("Q1",unique(x$quarter)), substr(unique(x$quarter), 1, 4), "")) 
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/184_trade-dispute_china_imports.svg", "svg",
                width_pixels=1920, height_pixels= 2160)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/184_trade-dispute_china_imports.png", "png",
                width_pixels=1920, height_pixels= 2160)
```
![](graphics/final/png/xxx)



#### Decrease between 2017 and 2019
```{r}
imports2017 = sum(x$value.country[x$country == "USA" & grepl("2017", x$quarter)]) / 10^6
share17 = x$share[x$country == "USA" & x$quarter == "2017-Q4"]
share19 = x$share[x$country == "USA" & x$quarter == "2019-Q4"]
decrease1719 = share17 - share19
loss1719 = imports2017 * decrease1719
```

In 2017, the US imported products worth USD `r round(imports2017)` bn from China. That was around `r round(share17*100)`% of all US imports. By Q4 2019, China provided only `r round(share19*100)`% of US imports. With the 2017 figures as a baseline, this decrease of `r round(decrease1719*100)`% equals a loss of around USD `r round(loss1719)` bn per year.

```{r}
rm(imports2017Q4, share17, share19, decrease1719, loss1719)
```


### 1.2 Who are the main importers to the US?

```{r}
d_usa %>% filter(p.code == "TOTAL") %>%
  left_join(d_usa_total %>% filter(p.code == "TOTAL"),
            by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = round((value.country / value.total)*100, 1)) %>%
  select(-value.country, -value.total,-p.code) %>% 
  spread(quarter, share) %>% 
  arrange(-`2020-Q2`) %>% 
  write.csv2("data/processed/output/trade-usa-imports-share-countries.csv",row.names = F, na = "")

```


```{r}
tmp = d_usa %>% group_by(country) %>% summarise(value.total = sum(value)) %>% arrange(-value.total) %>% head(5) %>% `$`(country)
x = d_usa %>% filter(p.code == "TOTAL") %>%
  mutate(country = ifelse(country %in% tmp, country, "Others")) %>% 
  group_by(quarter, country) %>% summarise(value = sum(value)) %>% 
  left_join(d_usa_total %>% filter(p.code == "TOTAL"),
            by = c("quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = value.country / value.total,
         country = factor(country, levels = c(tmp,"Others") %>% rev))

ggplot(x, aes(quarter, share, group = country, fill = country)) + 
  geom_area() +
  geom_vline(xintercept = c(13,19), colour =  dw_grey[14], size = 1) +
  scale_fill_manual(values = c(dw_grey[7],dw_info[5:1]) %>% unname) +
  scale_y_continuous(labels = scales::percent) +
  labs(y="", title = "US import shares by origin country over time", caption = "First line: start of the US-China trade dispute (July 2018), second line: WHO declares Covid a pandemic (March 2020") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), panel.grid = element_blank())
ggsave("graphics/video/svg/trade_dispute_2_area.svg", device = "svg", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.3)
ggsave("graphics/video/png/trade_dispute_2_area.png", device = "png", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.3)
```


### 1.3 What are the main US imports from China?
```{r}
p.top = d_usa %>% filter(country == "China", !(p.code %in% c("TOTAL","9999")), quarter == "2017-Q4") %>%
  left_join(p) %>% group_by(p.code.clean, short.name) %>% summarise(value = sum(value)) %>%
  arrange(-value) %>% head(11) %>% select(p.code.clean, short.name) %>% ungroup %>% 
  mutate(short.name = factor(short.name, levels = rev(short.name)))

x = d_usa %>% filter(country == "China", p.code != "TOTAL", quarter %in% c("2019-Q4","2017-Q4")) %>%
  left_join(p[-c(2,4)]) %>% left_join(p.top, by = "p.code.clean") %>% filter(!is.na(short.name)) %>% 
  group_by(p.code.clean, short.name, quarter) %>% summarise(value = sum(value)) %>% 
  mutate(quarter = factor(quarter, levels = c("2019-Q4","2017-Q4"), labels = c("Q4 2019","Q4 2017")))
```

```{r}
#bar chart
ggplot(x %>% filter(short.name != "monitors"),
       aes(x = value/10^6, y = short.name, fill = quarter,
           label = round(value/10^6,1))) +
  geom_col(position="dodge") +
  geom_text(aes(x = value/10^6 + 0.15), position = position_dodge(width= 0.9), hjust = 0, vjust = 0.5) +
  facet_wrap(~quarter,ncol=1) +
  scale_fill_manual(values = dw_info[2:1] %>% unname) +
  labs(x = "billion USD",y="",title = "Change in most common US imports from China") + guides(fill = F) +
  theme_minimal() + theme(panel.grid.major.y = element_blank())
ggsave("graphics/video/svg/trade_dispute_3_bars.svg", device = "svg", width= 1920/72, height= 2700/72, dpi = 72, units="in", scale = 0.25)
ggsave("graphics/video/png/trade_dispute_3_bars.png", device = "png", width= 1920/72, height= 2700/72, dpi = 72, units="in", scale = 0.25)
```

```{r}
#handlebar chart
plot = ggplot(x %>% filter(short.name != "monitors"),
       aes(x = value/10^6, y = short.name, label = round(value/10^6,1))) +
  geom_line(colour = dw_grey[4], linetype = 1, size = 20) +
  geom_point(aes(colour = quarter), size = 20) +
  geom_text(hjust = .5, vjust = 1, nudge_y = -.3, size = 25) +
  scale_colour_manual(values = dw_info[1:2] %>% unname) +
  labs(x = "billion USD",y="",title = "Trade dispute affected all\nof US's biggest Chinese imports",
       caption = "Change in most common US imports from China") +
  theme_dw() 
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/185_trade-dispute_china_products.svg", "svg",
                width_pixels=1920, height_pixels= 2700)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/185_trade-dispute_china_products.png", "png",
                width_pixels=1920, height_pixels= 2700)
```


### 1.4 What share of Chinese products is tariffed?

for Q4 2019:
```{r}
d_usa %>% filter(quarter == "2019-Q4", p.code != "TOTAL", country == "China") %>% 
  mutate(tariff = ifelse(p.code %in% t$HTS_id, "Tariffed","Untariffed")) %>%
  select(-country,-quarter) %>% group_by(tariff) %>% summarise(n = n(), value = sum(value)) %>% 
  mutate(`Number of categories` = n/sum(n), `Import value` = value/sum(value)) %>% 
  select(-n, -value) #%>% knitr::kable(digits = 2)
```
95% of products and 93% of US import value are subject to tariffs.

## 2. Change during Covid

### 2.1 Which product imports from China have risen the most from Q4 2019 to Q2 2020?
```{r}
x = d_usa %>% filter(country == "China", quarter %in% c("2019-Q4","2020-Q2")) %>%
  spread(quarter,value) %>% filter(`2019-Q4`>10^5,`2020-Q2`>10^5) %>% 
  mutate(change = `2020-Q2`/`2019-Q4`) %>% arrange(-change) %>% select(-country)

head(x, 10) %>% left_join(p) %>% select(1,7,2:4) #%>% knitr::kable()
```

Many medical products have skyrocketed. The category of textiles that includes face masks has increased almost ten-fold between Q4 2019 and Q2 2020.

### .2 Which product imports overall have risen the most from Q4 2019 to Q2 2020?
```{r}
x = d_usa %>% filter(quarter %in% c("2019-Q4","2020-Q2")) %>%
  group_by(quarter, p.code) %>% summarise(value = sum(value)) %>% 
  spread(quarter,value) %>% filter(`2019-Q4`>10^5,`2020-Q2`>10^5) %>% 
  mutate(change = `2020-Q2`/`2019-Q4`) %>% arrange(-change)

head(x, 10) %>% left_join(p) %>% select(1,7,2:4) #%>% knitr::kable()
```

Some medical products, others seem to be seasonal.

## 3. Trade redirection effects

To estimate the effect of trade redirection on different products, we'll look at how the market share of different countries in each product has changed over time. We would expect that in products affected by tariffs, China's market share would drop, and other countries' market shares would rise instead.

The percentage point difference in market share of country c in the import market for product p is described as:

![(US imports of product p from country c in Q4 2019/US imports of product p in Q4 2019) -
(US imports of product p from country c in Q4 2017/US imports of product p in Q4 2017)](tradedispute_files/equation_1.png)

or: 

```
(US imports of product p from country c in Q4 2019/US imports of product p in Q4 2019) -
(US imports of product p from country c in Q4 2017/US imports of product p in Q4 2017) =

US import market share of country c in product p in Q4 2019 -
US import market share of country c in product p in Q4 2017
```

```{r}
tmp = d_usa_total %>% filter(quarter %in% c("2019-Q4","2017-Q4"), p.code != "TOTAL")

#calculate market share change between the two quarters of each country for each product
d_redirections = d_usa %>% filter(quarter %in% c("2019-Q4","2017-Q4"), p.code != "TOTAL") %>% 
  #append totals for each product in that quarter
  left_join(tmp, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  left_join(p[-2]) %>% group_by(country, quarter, p.code.clean, short.name) %>% 
  #calculate share of each country in imports of that product
  summarise(value.country = sum(value.country), value.total = sum(value.total)) %>% 
  mutate(share = value.country / value.total) %>% select(-value.country, -value.total) %>% 
  spread(quarter,share) %>%
  #add tariff info
  mutate(tariff = ifelse(p.code.clean %in% t$p.code.clean, "Tariffed","Untariffed"),
         change = `2019-Q4`-`2017-Q4`)
rm(tmp)
```

### 3.1 Estimate the loss of China’s market share in US imports
Which products have seen the largest drop in China's market share within US imports?

**China's average market share decline in tariffed vs non-tariffed products:**
```{r}
x = d_redirections %>% filter(country == "China") %>% group_by(tariff) %>%
  summarise(change = mean(change, na.rm = T))
drop.notariff = x$change[2]
x #%>% knitr::kable(digits = 3)
```

Imports of tariffed products fell by 3.4 percentage points on average, while non-tariffed items fell by only 0.7 percentage points.


**Which imports to the US have been affected by import substitution away from China?**

i.e. for which products has China's market share dropped more than that of non-tariffed products between Q4 2017 and Q4 2019?

```{r}
#list of products for which China's market share dropped more than the average of non-tariffed products
tmp = d_redirections %>% filter(country == "China", change <= drop.notariff) %>% `$`(p.code.clean)
#add info to changes dataset
d_redirections = d_redirections %>% mutate(subs = p.code.clean %in% tmp)
rm(tmp)

d_redirections_all = d_redirections
```


```{r}
tmp = d_usa %>% filter(quarter == "2019-Q4", p.code != "TOTAL", country == "China") %>%  
  left_join(p[-2]) %>% group_by(p.code.clean) %>% 
  summarise(value_19Q4 = sum(value))

d_redirections_all %>% filter(country == "China") %>% 
  left_join(tmp, by = "p.code.clean") %>% filter(tariff == "Tariffed", !is.na(subs)) %>%
  group_by(subs) %>% summarise(n = n(), value_19Q4 = sum(value_19Q4)/10^6) %>% 
  mutate(`Number of categories` = n/sum(n), `Import value` = value_19Q4/sum(value_19Q4)) #%>% knitr::kable(digits = 2)
```

Indication of import substitution can be found in 654 tariffed product categories (57% of all product categories), making up 84% of tariffed US import value in Q4 2019 (USD 89 bn).

Next, we calculate the *change in imports* for 654 tariffed products with indication of import substitution. 
This is expressed as:

```
change in imports of prouct p from country c =
    change in country c's share in US imports of product p * total US import value in Q4 2019
```

with the change in country c's share in US imports of product p defined as:

```
(US imports of product p from country c in Q4 2019/US imports of product p in Q4 2019) -
(US imports of product p from country c in Q4 2017/US imports of product p in Q4 2017) =

US import market share of country c in product p in Q4 2019 -
US import market share of country c in product p in Q4 2017
```
```{r}
tmp = d_usa_total %>% filter(grepl("[97]-Q4",quarter), p.code != "TOTAL") %>%
  mutate(quarter = paste0("value_", substr(quarter, 3,4),"Q4")) %>%
  left_join(p[-2], by = "p.code") %>% group_by(quarter, p.code.clean) %>%
  summarise(value = sum(value)/10^6) %>% 
  spread(quarter, value)

d_redirections = d_redirections_all %>% left_join(tmp, by = c("p.code.clean")) %>%
  filter(tariff == "Tariffed", subs == T) %>% 
  mutate(change.imports.bn = change * value_19Q4) %>% 
  select(1:5,7,11,9,10) %>% ungroup()
```

**Which products are most heavily impacted by the tariffs?**

Filter for products imported by China with the highest loss in imports.

```{r}
d_redirections %>% filter(country == "China") %>% arrange(change.imports.bn) %>% 
  select(-country) %>% head(10) #%>% knitr::kable(digits = 2)
```


Exports of computers, furniture and cell phones from China to the US have been most heavily affected by the tariffs. For example, China used to provide 62% of imported US computers. In Q4 2019, it only provided 44%. That corresponds to a loss of around USD5bn over the two years of the trade dispute.

### 3.2 Estimate additional imports to ths US from third party countries

Filter for products with the most additional imports:

```{r}
d_redirections %>% filter(country != "China") %>% arrange(-change.imports.bn) %>% head(10) #%>% knitr::kable(digits = 2)
```

Cell phones from Vietnam, computers from Mexico and Taiwan have gained the most.


#### sum by product

```{r}
d_redirections %>% filter(country != "China") %>% group_by(p.code.clean, short.name) %>%
  summarise(change.imports.bn = sum(change.imports.bn)) %>% arrange(-change.imports.bn) %>%
  head(20) #%>% knitr::kable(digits = 2)
```

Computers/computer parts (USD 5bn), furniture (USD 1.7bn) and cell phones  (USD 1.5bn) have gained the most overall.

```{r}
#### products mexico
d_redirections %>% filter(country == "Mexico") %>% arrange(-change.imports.bn) %>% head(50) %>% write.csv("data/processed/output/trade-redirection-products-mexico.csv", row.names = F)
```


#### sum by country

```{r}
x = d_redirections %>% group_by(country) %>%
  summarise(change.imports.bn = sum(change.imports.bn)) %>% arrange(-change.imports.bn) %>%
  head(10) 
x #%>% knitr::kable(digits = 2)
```

Vietnam, Mexico and Taiwan have gained the most overall.

```{r}
plot = ggplot(x %>% mutate(country = factor(country, levels = country %>% rev,
                                            labels = c(x$country[10:8], "Russia", "South Korea",
                                                       x$country[5:4],"Taiwan","Mexico","Vietnam"))),
       aes(change.imports.bn, country)) +
  geom_bar(stat = "identity", fill = dw_info[1], width = .7) +
  scale_x_continuous(expand = expansion(mult = c(0,0))) +
  scale_y_discrete(expand = expansion(mult = c(0,0))) +
  theme_dw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(size = 1, colour = dw_grey[7]),
        axis.line.x = element_blank()) +
  labs(title = "Vietnam and Mexico gained the most in\nthe first two years of the trade dispute",
       caption = "quarterly exports to the US gained between Q4 2017 and Q4 2019",
       x = "USD bn")

finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_winners_gains.svg", "svg",
                width_pixels=1920, height_pixels= 2700)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_winners_gains.png", "png",
                width_pixels=1920, height_pixels= 2700)
```


#### scale by GDP

```{r}
d_redirections %>% group_by(country) %>%
  summarise(change.imports.bn = sum(change.imports.bn)) %>%
  arrange(-change.imports.bn) %>% left_join(gdp[2:3]) %>%
  mutate(gdp18 = gdp18/10^9, perc.gdp = change.imports.bn/gdp18*100) %>% arrange(-perc.gdp) %>% 
  select(1,4,3,2) %>% head(10) #%>% knitr::kable(digits = 2)
```

Relative to GDP, Vietnam has benefited the most. The added USD 6.4bn equal 2.6% of the countrie's 2018 GDP.

## 4. Market share changes by country

### South-East Asia: Beneficiary countries who have kept their gains during the pandemic

```{r}
x = d_usa %>%
  filter(p.code == "TOTAL", country %in% c("Viet Nam","Malaysia","Korea, Republic of","Taipei, Chinese")) %>% 
  left_join(d_usa_total, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = value.country / value.total,
         country = factor(country, levels = c("Viet Nam","Korea, Republic of","Taipei, Chinese","Malaysia"),
                          labels = c("Vietnam","South Korea","Taiwan","Malaysia")))
plot = ggplot(x, aes(quarter, share, group = country, colour = country)) +
  geom_line(size = 8, lineend = "round") +
  geom_vline(xintercept = c(13,19), colour =  "#002d5a", size = 4) +
  annotate("text", c(13,19)-.2, y = .001, hjust = 1, vjust = 0, colour = dw_grey[13],
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\npandemic"), size = 18) +
  scale_colour_manual(values = dw_info[1:4] %>% unname) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limits = c(0,max(x$share)), expand = expansion(mult = c(0,.05))) +
  theme_minimal() + theme(panel.grid.minor = element_blank()) +
  labs(title = "South-East Asian countries have held on\nto gains during the pandemic",
       caption = "Import market shares of current trade dispute beneficiaries")
ggsave("graphics/video/svg/trade_dispute_5_marketshareWinners.svg", plot, device = "svg", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.25)
ggsave("graphics/video/png/trade_dispute_5_marketshareWinners.png", plot, device = "png", width= 1920/72, height= 1080/72, dpi = 72, units="in", scale = 0.25)

plot = plot + theme_dw() +
  theme(legend.position = "right") +
  scale_x_discrete(labels = ifelse(grepl("Q1",unique(x$quarter)), substr(unique(x$quarter), 1, 4), ""))
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_winners.svg", "svg",
                width_pixels=1920, height_pixels= 2160)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_winners.png", "png",
                width_pixels=1920, height_pixels= 2160)
```

### Others: Beneficiary countries who have not kept their gains
```{r}
x = d_usa %>% filter(p.code == "TOTAL", country %in% c("Mexico", "Canada")) %>% 
  left_join(d_usa_total, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  mutate(share = value.country / value.total)

for(i in 1:2){
  country_i = c("Mexico", "Canada")
  plot = ggplot(x %>% filter(country == country_i[i]), aes(quarter, share, group = 0)) +
    geom_line(size = 3, lineend = "round", colour = dw_info[i]) +
    ggtitle(paste("Share of imports from",country_i[i],"in all imports to the USA")) +
    geom_vline(xintercept = 13, colour =  "#002d5a", size = 1) +
    geom_vline(xintercept = 19, colour =  "#002d5a", size = 1) +
    scale_y_continuous(labels = scales::percent) + guides (colour = FALSE) +
    theme_minimal() +
    theme(panel.grid.minor = element_blank())
  ggsave(paste0("graphics/video/svg/trade_dispute_4_",i,"_marketshare",country_i[i],".svg"), plot, device = "svg",
         width= 1920/72, height= 1080/72, dpi = 72,units="in", scale = 0.3)
  ggsave(paste0("graphics/video/png/trade_dispute_4_",i,"_marketshare",country_i[i],".png"), plot, device = "png",
         width= 1920/72, height= 1080/72,dpi = 72, units="in", scale = 0.3)
}

plot = ggplot(x %>% filter(country == "Mexico"), aes(quarter, share, group = 0)) +
    geom_line(size = 8, lineend = "round", colour = dw_info[1]) +
    geom_vline(xintercept = c(13,19), colour = "#002d5a", size = 4) +
    annotate("text", c(13,19)-.1, y = .005, hjust = 1, vjust = 0, colour = dw_grey[13],
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\nCovid a pandemic"), size = 18) +
    scale_x_discrete(labels = ifelse(grepl("Q1",unique(x$quarter)), substr(unique(x$quarter), 1, 4), "")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       limits = c(0,max(x$share)), expand = expansion(mult = c(0,.05))) +
    labs(title = "Mexico's exports to the US\nhave dropped during the pandemic",
       caption = "Market share of Mexico in all US imports") +
    theme_dw()
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_mexico.svg", "svg",
                width_pixels=1920, height_pixels= 2160)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_mexico.png", "png",
                width_pixels=1920, height_pixels= 2160)
```


## 5. Market share changes by product

### computers market share

```{r}
x = d_usa %>% filter(p.code %in% c(8471,8473), country %in% c("China","Mexico","Viet Nam")) %>% 
  left_join(d_usa_total, by = c("p.code","quarter"), suffix = c(".country",".total")) %>% 
  left_join(p[-2]) %>% group_by(country, quarter, p.code.clean, short.name) %>%
  summarise(value.country = sum(value.country), value.total = sum(value.total)) %>% 
  mutate(share = value.country / value.total) %>% select(-value.country, -value.total) %>% 
  ungroup()

plot = ggplot(x, aes(quarter, share, fill = country, group = country)) +
  geom_area() +
  geom_vline(xintercept = c(13,19), colour =  dw_info[5], size = 4) +
  annotate("text", c(13,19)-.1, y = 1.1, hjust = 1, vjust = 1, colour = dw_grey[13],
           label = c("July 2018\nstart of the\ntrade dispute",
                     "March 2020\nWHO declares\nCovid a pandemic"), size = 18) +
  scale_fill_manual(values = dw_info[1:4] %>% unname) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1.1), expand = expansion(mult = c(0,0))) +
  scale_x_discrete(labels = ifelse(grepl("Q1",unique(x$quarter)), substr(unique(x$quarter), 1, 4), ""),
                   expand = expansion(mult = c(0,0))) +
  labs(title = "The US now imports computers from\nTaipei and Mexico instead of China",
       caption = "Market share of Mexico in all US imports") +
  theme_dw() + theme(panel.grid = element_blank())
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_computers.svg", "svg",
                width_pixels=1920, height_pixels= 2160)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_marketshare_computers.png", "png",
                width_pixels=1920, height_pixels= 2160)
```

### bubble chart: import value changes by country and product

```{r}
# video edition: china vs vietnam
x = d_usa %>%
  filter(country %in% c("China","Viet Nam"),
         quarter %in% c("2017-Q4","2019-Q4"), p.code != "TOTAL",
         p.code %in% t$HTS_id) %>%
  left_join(p, by = "p.code") %>%
  group_by(p.code.clean, short.name, quarter, country) %>% summarise(value = sum(value)) %>% 
  spread(quarter,value) %>% filter(`2019-Q4`>5*10^3,`2017-Q4`>5*10^3) %>% 
  mutate(change = (`2019-Q4`/`2017-Q4`),
         col = ifelse(short.name %in% c("cell phones","computers","furniture",
                                        "clothing","shoes"), short.name,"other") %>%
           factor(., levels = c("cell phones","computers","furniture",
                                "clothing","shoes","other"))) %>% 
  arrange(desc(col))

plot = ggplot(x, aes(y = change, x = country, size = `2019-Q4`, fill = col)) +
  geom_hline(yintercept = 1, colour = "#323c45", size = 1) +
  geom_quasirandom(width = 0.6, method = "quasirandom", varwidth = T, bandwidth = 1,
                   shape = 21, colour = "#f1f3f5", alpha = 0.8) +
  scale_x_discrete(expand = expansion(mult = c(.8, .5))) +
  scale_size_continuous(range = c(1,20)) +
  scale_fill_manual(values =c(dw_info[1:5],dw_grey[7]) %>% unname) +
  labs(title = "Electronics exports from Vietnam and Taiwan boom as China's decrease",
       subtitle = "change in US imports 2017 - 2019. size by volume in USD",
       x = "", y = "change in US imports from Q4 2017 to Q4 2019") +
  coord_flip() + guides(size = F) + theme_minimal() +
  theme(legend.position="bottom",
        panel.grid.major.y = element_blank())

plot + scale_y_continuous(limits = c(0,4), labels = scales::label_number(accuracy = 1, suffix = "x"))
ggsave("graphics/video/svg/trade_dispute_6_1_bubbles_zoomin.svg", device = "svg", width= 1920/72, height= 1620/72, dpi = 72, units="in", scale = 0.25)
ggsave("graphics/video/png/trade_dispute_6_1_bubbles_zoomin.png", device = "png", width= 1920/72, height= 1620/72, dpi = 72, units="in", scale = 0.25)
plot + scale_y_continuous(labels = scales::label_number(accuracy = 1, suffix = "x"))
ggsave("graphics/video/svg/trade_dispute_6_2_bubbles_zoomout.svg", device = "svg", width= 1920/72, height= 1620/72, dpi = 72, units="in", scale = 0.25)
ggsave("graphics/video/png/trade_dispute_6_2_bubbles_zoomout.png", device = "png", width= 1920/72, height= 1620/72, dpi = 72, units="in", scale = 0.25)
```

```{r fig.width=3,fig.height=3}
# southeast asia edition
x = d_usa %>%
  filter(country %in% c("China","Viet Nam","Malaysia","Taipei, Chinese"),
         quarter %in% c("2017-Q4","2019-Q4"), p.code != "TOTAL",
         p.code %in% t$HTS_id) %>%
  left_join(p, by = "p.code") %>%
  group_by(p.code.clean, short.name, quarter, country) %>% summarise(value = sum(value)) %>% 
  spread(quarter,value) %>% filter(`2019-Q4`>5*10^3,`2017-Q4`>5*10^3) %>% 
  mutate(change = (`2019-Q4`/`2017-Q4`),
         country = ifelse(country == "Taipei, Chinese", "Taiwan", country) %>% 
           ifelse(country == "Viet Nam", "Vietnam", .),
         col = ifelse(short.name %in% c("cell phones","computers","furniture",
                                        "gaming consoles","clothing","shoes"), short.name,"other") %>%
           factor(., levels = c("cell phones","computers","furniture",
                                "gaming consoles","clothing","shoes","other"))) %>% 
  arrange(desc(col))

plot = ggplot(x, aes(y = change, x = country, size = `2019-Q4`, fill = col)) +
  geom_hline(yintercept = 1, colour = dw_grey[13], size = 2) +
  geom_quasirandom(width = 0.6, method = "quasirandom", varwidth = T, bandwidth = 1,
                   shape = 21, colour = dw_grey[1]) +
  scale_x_discrete(expand = expansion(mult = c(.3, .2))) +
  scale_y_continuous(limits = c(0,3), labels = scales::label_number(accuracy = 1, suffix = "x")) +
  scale_size_continuous(range = c(5,80)) +
  scale_fill_manual(values = c(dw_info %>% unname,dw_grey[7])) +
  labs(title = "Electronics exports from Vietnam\nand Taiwan boom as China's decrease",
       caption = "change in US imports from Q4 2017 to Q4 2019.\nsize by volume in USD") +
  coord_flip() + guides(size = F, fill = guide_legend(override.aes = list(size = 15))) + theme_dw() +
  theme(legend.position="bottom", legend.text = element_text(size = 45),
        panel.grid.major.y = element_blank())

finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_product_bubbles.svg", "svg",
                width_pixels=1920, height_pixels= 2700)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_product_bubbles.png", "png",
                width_pixels=1920, height_pixels= 2700)
```

```{r fig.width=3,fig.height=3}
#mexico edition
x = d_usa %>%
  filter(country %in% c("China","Mexico"),
         quarter %in% c("2017-Q4","2019-Q4"), p.code != "TOTAL",
         p.code %in% t$HTS_id) %>%
  left_join(p, by = "p.code") %>%
  #only include products with at leat 5 mn import value in both countries and both quarters
  group_by(p.code.clean, short.name, quarter, country) %>% summarise(value = sum(value)) %>%
  group_by(p.code.clean, short.name) %>% filter(all(value>5*10^3)) %>% 
  spread(quarter,value) %>% 
  mutate(change = (`2019-Q4`/`2017-Q4`),
         col = ifelse(short.name %in% c("computers","cars","car parts",
                                        "engines","storage media","hats"), short.name,"other") %>%
           factor(., levels = c("computers","cars","car parts","engines","storage media","hats","other"))) %>% 
  arrange(desc(col))

plot = ggplot(x, aes(y = change, x = country, size = `2019-Q4`, fill = col)) +
  geom_hline(yintercept = 1, colour = dw_grey[13], size = 2) +
  geom_quasirandom(width = 0.4, method = "quasirandom", varwidth = T, bandwidth = 1,
                   shape = 21, colour = dw_grey[1]) +
  scale_x_discrete(expand = expansion(mult = c(.45, .45))) +
  scale_y_continuous(limits = c(0,3), labels = scales::label_number(accuracy = 1, suffix = "x")) +
  scale_size_continuous(range = c(5,80)) +
  scale_fill_manual(values = c(dw_info %>% unname,dw_grey[7])) +
  labs(title = "Electronics exports from Mexico boom\nas China's decrease",
       caption = "change in US imports from Q4 2017 to Q4 2019.\nsize by import volume in USD") +
  coord_flip() + guides(size = F, fill = guide_legend(override.aes = list(size = 15))) + theme_dw() +
  theme(legend.position="bottom", panel.grid.major.x = element_line(colour = dw_grey[7]),
        panel.grid.major.y = element_blank())

finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_product_bubbles_mexico.svg", "svg",
                width_pixels=1920, height_pixels= 2400)
finalise_dwplot(plot,"Source: ITC Trade Map | Methodology: github.com/dw-data/trade-dispute", "graphics/preliminary/xxx_trade-dispute_product_bubbles_mexico.png", "png",
                width_pixels=1920, height_pixels= 2400)
```

